<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>
        <%= mail.subject %> - Javalorant
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --md-surface: #fdfbff;
            --md-surface-variant: #e1e2ec;
            --md-primary: #0056d6;
            --md-on-surface: #1b1b1f;
            --md-outline: #74777f;
            --md-body-bg: #fdfbff;
            --md-card-bg: #ffffff;
            --md-reply-bg: #f3f3f9;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --md-surface: #111318;
                --md-surface-variant: #44474e;
                --md-primary: #adc6ff;
                /* Xanh s√°ng ƒë·∫∑c tr∆∞ng M3 Dark */
                --md-on-surface: #e3e2e6;
                --md-outline: #8e9099;
                --md-body-bg: #111318;
                --md-card-bg: #1b1b1f;
                --md-reply-bg: #232326;
            }

            body {
                background-color: var(--md-body-bg) !important;
                color: var(--md-on-surface) !important;
            }

            /* CARD CH√çNH PH·∫¢I C√ì ƒê·ªò N·ªîI (ELEVATION) */
            .email-container {
                background-color: var(--md-card-bg) !important;
                border: 1px solid var(--md-surface-variant) !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;
            }

            .email-header {
                border-bottom-color: var(--md-surface-variant) !important;
            }

            .email-subject {
                color: var(--md-primary) !important;
                font-weight: 700 !important;
            }

            /* √âP CH·ªÆ TRONG BODY PH·∫¢I S√ÅNG ƒê·ªÇ ƒê·ªåC ƒê∆Ø·ª¢C */
            .email-body,
            .email-body * {
                color: var(--md-on-surface) !important;
                background-color: transparent !important;
            }

            /* S·ª¨A REPLY BOX NH√åN CHO SANG */
            .reply-container {
                background-color: var(--md-reply-bg) !important;
                border-radius: 32px !important;
            }

            .reply-input-wrapper {
                background: #2b2b2f !important;
                border-color: var(--md-outline) !important;
                border-radius: 24px !important;
            }

            textarea.m3-textarea {
                color: #ffffff !important;
            }

            /* AVATAR V√Ä ICON S√ÅNG B·ª™NG */
            .avatar-m3 {
                background-color: var(--md-primary) !important;
                color: #001a41 !important;
            }

            .btn-m3-icon {
                color: var(--md-on-surface) !important;
            }

            .btn-m3-icon:hover {
                background-color: rgba(255, 255, 255, 0.08) !important;
            }

            /* ATTACHMENT CHIPS PH·∫¢I N·ªîI */
            .attachment-chip {
                background-color: #2b2b2f !important;
                border-color: var(--md-surface-variant) !important;
                color: var(--md-on-surface) !important;
                border-radius: 16px !important;
            }

            .attachment-chip .text-dark {
                color: var(--md-on-surface) !important;
            }

            .bg-primary-subtle {
                background-color: rgba(173, 198, 255, 0.15) !important;
            }
        }

        /* CSS G·ªêC C·ª¶A M√ÄY GI·ªÆ NGUY√äN B√äN D∆Ø·ªöI ƒê·ªÇ CH·∫†Y LIGHT MODE */
        body {
            background-color: var(--md-surface);
            color: var(--md-on-surface);
            font-family: 'Google Sans', 'Segoe UI', system-ui, sans-serif;
            padding-bottom: 50px;
        }

        .top-bar {
            margin: 20px 0;
        }

        .btn-m3-icon {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            transition: background 0.2s;
            color: var(--md-on-surface);
        }

        .btn-m3-icon:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .email-container {
            background-color: var(--md-card-bg);
            border-radius: 28px;
            border: 1px solid var(--md-surface-variant);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .email-header {
            padding: 32px;
            border-bottom: 1px solid var(--md-surface-variant);
        }

        .email-subject {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 24px;
        }

        .sender-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .avatar-m3 {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            background-color: var(--md-primary);
            color: #001a41;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 20px;
        }

        .email-body {
            padding: 32px;
            line-height: 1.6;
            font-size: 16px;
            min-height: 200px;
        }

        .email-body img {
            max-width: 100%;
            border-radius: 16px;
        }

        .reply-container {
            background-color: #f3f3f9;
            border-radius: 28px;
            padding: 24px;
        }

        .reply-input-wrapper {
            background: white;
            border-radius: 24px;
            border: 1px solid var(--md-outline);
            padding: 12px 20px;
            transition: border 0.2s;
        }

        .reply-input-wrapper:focus-within {
            border: 2px solid var(--md-primary);
        }

        textarea.m3-textarea {
            border: none;
            width: 100%;
            outline: none;
            resize: none;
            font-size: 15px;
            color: var(--md-on-surface);
        }

        .attachment-chip {
            background-color: white;
            border: 1px solid var(--md-outline);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: inherit;
            transition: background 0.2s;
        }

        .attachment-chip:hover {
            background-color: var(--md-surface-variant);
        }

        @media print {
            .no-print {
                display: none !important;
            }

            .email-container {
                border: none;
            }
        }
    </style>
</head>

<body>
    <div class="container" style="max-width: 960px;">
        <div class="top-bar d-flex justify-content-between align-items-center no-print">
            <a href="/" class="btn-m3-icon" title="Back to Inbox">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="d-flex gap-2">
                <button class="btn-m3-icon" onclick="window.print()"><i class="fas fa-print"></i></button>
                <button class="btn-m3-icon text-danger" onclick="trashThisMail('<%= mail.id %>')"><i
                        class="fas fa-trash-alt"></i></button>
            </div>
        </div>

        <div class="email-container shadow-sm">
            <div class="email-header">
                <h1 class="email-subject text-dark">
                    <%= mail.subject %>
                </h1>
                <div class="sender-info">
                    <div class="avatar-m3">
                        <%= mail.from.text.charAt(0).toUpperCase() %>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">
                            <%= mail.from.text %>
                        </div>
                        <div class="text-muted small">To: me &lt;<%= user %>&gt;</div>
                    </div>
                    <div class="text-end text-muted small">
                        <%= new Date(mail.date).toLocaleString('en-US', { hour: '2-digit' , minute: '2-digit' ,
                            day: 'numeric' , month: 'short' }) %>
                    </div>
                </div>
            </div>

            <div class="email-body">
                <%- mail.html ? mail.html : mail.textAsHtml %>

                    <% if (attachments && attachments.length> 0) { %>
                        <div class="mt-5 pt-4 border-top no-print">
                            <p class="small fw-bold text-muted mb-3"><i class="fas fa-paperclip me-2"></i>Attachments (
                                <%= attachments.length %>)
                            </p>
                            <div class="d-flex flex-wrap gap-3">
                                <% attachments.forEach(file=> { %>
                                    <a href="<%= file.downloadLink %>"
                                        class="attachment-chip shadow-sm border d-flex align-items-center p-3"
                                        style="min-width: 220px; border-radius: 16px;">
                                        <div class="bg-primary-subtle p-2 rounded-3 me-3">
                                            <i class="fas fa-file-download text-primary fa-lg"></i>
                                        </div>
                                        <div class="overflow-hidden">
                                            <div class="small fw-bold text-dark text-truncate" style="max-width: 150px;"
                                                title="<%= file.filename %>">
                                                <%= file.filename %>
                                            </div>
                                            <div class="text-muted" style="font-size: 11px;">
                                                <%= file.size %>
                                            </div>
                                        </div>
                                    </a>
                                    <% }) %>
                            </div>
                        </div>
                        <% } %>
            </div>
        </div>

        <div class="reply-container no-print">
            <div class="d-flex align-items-center gap-2 mb-3">
                <i class="fas fa-bolt text-warning"></i>
                <span class="fw-bold small text-muted">Quick Reply</span>
            </div>
            <form action="/send" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="to" value="<%= mail.from.value[0].address %>">
                <input type="hidden" name="subject" value="Re: <%= mail.subject %>">
                <div class="reply-input-wrapper">
                    <textarea name="message" class="m3-textarea" rows="3"
                        placeholder="Vi·∫øt ph·∫£n h·ªìi cho ƒë·∫°i gia Th√†nh..."></textarea>

                    <div id="selected-files-display" class="d-flex flex-wrap gap-2 px-2 pb-2"></div>

                    <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
                        <label class="btn-m3-icon" title="Attach Files"
                            style="width: 36px; height: 36px; cursor: pointer;">
                            <i class="fas fa-paperclip small"></i>
                            <input type="file" name="attachments" id="quick-attach-input" multiple
                                style="display: none;">
                        </label>
                        <button type="submit" class="btn btn-primary rounded-pill px-4 btn-sm fw-bold shadow-sm">
                            Send Reply <i class="fas fa-paper-plane ms-1"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let selectedFilesArray = [];
        const MAX_SIZE_MB = 10; // Gi·ªõi h·∫°n 10MB cho n√≥ an to√†n, Th√†nh ∆°i

        // LOGIC CH·ªåN NHI·ªÄU FILE & CHECK DUNG L∆Ø·ª¢NG
        $('#quick-attach-input').on('change', function (e) {
            const newFiles = Array.from(this.files);
            let totalSize = selectedFilesArray.reduce((acc, f) => acc + f.size, 0);

            newFiles.forEach(file => {
                if ((totalSize + file.size) / (1024 * 1024) > MAX_SIZE_MB) {
                    alert(`ƒêm Th√†nh, file "${file.name}" l√†m mail n·∫∑ng qu√° 10MB r·ªìi, b·ªõt tham ƒëi!`);
                } else {
                    selectedFilesArray.push(file);
                    totalSize += file.size;
                }
            });

            renderFiles();
            $(this).val(''); // Reset input ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i c√πng 1 file n·∫øu l·ª° tay x√≥a
        });

        function renderFiles() {
            const $display = $('#selected-files-display');
            $display.empty();

            selectedFilesArray.forEach((f, index) => {
                $display.append(`
                <div class="badge bg-primary-subtle text-primary border p-2 rounded-pill small d-flex align-items-center gap-2 shadow-sm mb-1 me-1">
                    <i class="fas fa-file-alt"></i> 
                    <span class="text-truncate" style="max-width: 120px;">${f.name}</span>
                    <span class="text-muted" style="font-size: 0.7em;">(${(f.size / 1024).toFixed(1)}KB)</span>
                    <i class="fas fa-times-circle text-danger" style="cursor:pointer" onclick="removeFile(${index})"></i>
                </div>
            `);
            });
        }

        function removeFile(index) {
            selectedFilesArray.splice(index, 1);
            renderFiles();
        }

        // AJAX SEND V·ªöI SPINNER CHO N√ì UY T√çN
        $('form').on('submit', function (e) {
            e.preventDefault();
            const $btn = $(this).find('button[type="submit"]');
            $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Sending...');

            const formData = new FormData(this);
            formData.delete('attachments');
            selectedFilesArray.forEach(file => formData.append('attachments', file));

            $.ajax({
                url: '/send',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (res) {
                    window.location.href = '/?msg=G·ª≠i th√†nh c√¥ng cmnr! üöÄ';
                },
                error: function (err) {
                    alert('L·ªói: ' + err.responseText);
                    $btn.prop('disabled', false).html('Send Reply <i class="fas fa-paper-plane ms-1"></i>');
                }
            });
        });
    </script>
</body>

</html>