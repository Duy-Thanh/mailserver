<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>
        <%= mail.subject %> - Javalorant
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        :root {
            --md-surface: #fdfbff;
            --md-surface-variant: #e1e2ec;
            --md-primary: #0056d6;
            --md-on-surface: #1b1b1f;
            --md-outline: #74777f;
        }

        body {
            background-color: var(--md-surface);
            color: var(--md-on-surface);
            font-family: 'Google Sans', 'Segoe UI', system-ui, sans-serif;
            padding-bottom: 50px;
        }

        /* N√öT BACK V√Ä ACTION TR√äN C√ôNG */
        .top-bar {
            margin: 20px 0;
        }

        .btn-m3-icon {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            transition: background 0.2s;
            color: var(--md-on-surface);
        }

        .btn-m3-icon:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* CARD ƒê·ªåC MAIL CH√çNH */
        .email-container {
            background-color: white;
            border-radius: 28px;
            /* Bo g√≥c c·ª±c ƒë·∫°i ki·ªÉu M3 */
            border: 1px solid var(--md-surface-variant);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .email-header {
            padding: 32px;
            border-bottom: 1px solid var(--md-surface-variant);
        }

        .email-subject {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 24px;
        }

        /* AVATAR V√Ä TH√îNG TIN NG∆Ø·ªúI G·ª¨I */
        .sender-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .avatar-m3 {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            background-color: var(--md-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 20px;
        }

        .email-body {
            padding: 32px;
            line-height: 1.6;
            font-size: 16px;
            min-height: 200px;
        }

        .email-body img {
            max-width: 100%;
            border-radius: 16px;
        }

        /* QUICK REPLY BOX KI·ªÇU M3 CHAT */
        .reply-container {
            background-color: #f3f3f9;
            border-radius: 28px;
            padding: 24px;
        }

        .reply-input-wrapper {
            background: white;
            border-radius: 24px;
            border: 1px solid var(--md-outline);
            padding: 12px 20px;
            transition: border 0.2s;
        }

        .reply-input-wrapper:focus-within {
            border: 2px solid var(--md-primary);
        }

        textarea.m3-textarea {
            border: none;
            width: 100%;
            outline: none;
            resize: none;
            font-size: 15px;
            color: var(--md-on-surface);
        }

        .attachment-chip {
            background-color: white;
            border: 1px solid var(--md-outline);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: inherit;
            transition: background 0.2s;
        }

        .attachment-chip:hover {
            background-color: var(--md-surface-variant);
        }

        @media print {
            .no-print {
                display: none !important;
            }

            .email-container {
                border: none;
            }
        }
    </style>
</head>

<body>
    <div class="container" style="max-width: 960px;">
        <div class="top-bar d-flex justify-content-between align-items-center no-print">
            <a href="/" class="btn-m3-icon" title="Back to Inbox">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="d-flex gap-2">
                <button class="btn-m3-icon" onclick="window.print()"><i class="fas fa-print"></i></button>
                <button class="btn-m3-icon text-danger" onclick="trashThisMail('<%= mail.id %>')"><i
                        class="fas fa-trash-alt"></i></button>
            </div>
        </div>

        <div class="email-container shadow-sm">
            <div class="email-header">
                <h1 class="email-subject text-dark">
                    <%= mail.subject %>
                </h1>
                <div class="sender-info">
                    <div class="avatar-m3">
                        <%= mail.from.text.charAt(0).toUpperCase() %>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">
                            <%= mail.from.text %>
                        </div>
                        <div class="text-muted small">To: me &lt;<%= user %>&gt;</div>
                    </div>
                    <div class="text-end text-muted small">
                        <%= new Date(mail.date).toLocaleString('en-US', { hour: '2-digit' , minute: '2-digit' ,
                            day: 'numeric' , month: 'short' }) %>
                    </div>
                </div>
            </div>

            <div class="email-body">
                <%- mail.html ? mail.html : mail.textAsHtml %>

                    <% if (attachments && attachments.length> 0) { %>
                        <div class="mt-5 pt-4 border-top no-print">
                            <p class="small fw-bold text-muted mb-3"><i class="fas fa-paperclip me-2"></i>Attachments (
                                <%= attachments.length %>)
                            </p>
                            <div class="d-flex flex-wrap gap-3">
                                <% attachments.forEach(file=> { %>
                                    <a href="<%= file.downloadLink %>"
                                        class="attachment-chip shadow-sm border d-flex align-items-center p-3"
                                        style="min-width: 220px; border-radius: 16px;">
                                        <div class="bg-primary-subtle p-2 rounded-3 me-3">
                                            <i class="fas fa-file-download text-primary fa-lg"></i>
                                        </div>
                                        <div class="overflow-hidden">
                                            <div class="small fw-bold text-dark text-truncate" style="max-width: 150px;"
                                                title="<%= file.filename %>">
                                                <%= file.filename %>
                                            </div>
                                            <div class="text-muted" style="font-size: 11px;">
                                                <%= file.size %>
                                            </div>
                                        </div>
                                    </a>
                                    <% }) %>
                            </div>
                        </div>
                        <% } %>
            </div>
        </div>

        <div class="reply-container no-print">
            <div class="d-flex align-items-center gap-2 mb-3">
                <i class="fas fa-bolt text-warning"></i>
                <span class="fw-bold small text-muted">Quick Reply</span>
            </div>
            <form action="/send" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="to" value="<%= mail.from.value[0].address %>">
                <input type="hidden" name="subject" value="Re: <%= mail.subject %>">
                <div class="reply-input-wrapper">
                    <textarea name="message" class="m3-textarea" rows="3" placeholder="Write your reply..."></textarea>

                    <div id="selected-files-list" class="d-flex flex-wrap gap-2 px-2 pb-2"></div>

                    <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
                        <label class="btn-m3-icon" title="Attach Files"
                            style="width: 36px; height: 36px; cursor: pointer;">
                            <i class="fas fa-paperclip small"></i>
                            <input type="file" name="attachments" id="quick-attach-input" multiple
                                style="display: none;">
                        </label>
                        <button type="submit" class="btn btn-primary rounded-pill px-4 btn-sm fw-bold">Send
                            Reply</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function trashThisMail(uid) {
            if (!confirm('X√≥a mail n√†y nh√© Th√†nh?')) return;
            $.post('/api/emails/move-to-trash', { uid: uid }, function (res) {
                window.location.href = '/?msg=ƒê√£ d·ªçn d·∫πp s·∫°ch s·∫Ω! üßπ';
            });
        }

        // ƒêO·∫†N N√ÄY ƒê·ªÇ HI·ªÜN MULTI-FILE
        $('#quick-attach-input').on('change', function () {
            const files = this.files;
            const $list = $('#selected-files-list');
            $list.empty();

            if (files && files.length > 0) {
                console.log("M√†y v·ª´a ch·ªçn " + files.length + " file!");
                Array.from(files).forEach((f) => {
                    $list.append(`
                        <div class="badge bg-primary-subtle text-primary border p-2 rounded-pill small d-flex align-items-center gap-2 shadow-sm mb-2 me-2">
                            <i class="fas fa-file-alt"></i> 
                            <span class="text-truncate" style="max-width: 150px;">${f.name}</span>
                            <i class="fas fa-check-circle text-success"></i>
                        </div>
                    `);
                });
            }
        });

        function clearAllFiles() {
            $('#quick-attach-input').val(''); // Reset input file
            $('#selected-files-list').empty(); // X√≥a s·∫°ch giao di·ªán c√°c Badge
        }
    </script>
</body>

</html>